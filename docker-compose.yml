version: '3.8'

services:
  node1:
    build: .
    container_name: uploader-node1
    hostname: node1
    ports:
      - "50051:50051"
      - "9000:9000"
    volumes:
      - ./storage-node1:/app/storage
      - ./certs-node1:/app/certs
      - ./config-node1.toml:/app/config.toml:ro
    environment:
      - RUST_LOG=info
      - NODE_NAME=node-1
    networks:
      - uploader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "uploader", "ping", "--server", "127.0.0.1:50051"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  node2:
    build: .
    container_name: uploader-node2
    hostname: node2
    ports:
      - "50052:50051"
      - "9001:9000"
    volumes:
      - ./storage-node2:/app/storage
      - ./certs-node2:/app/certs
      - ./config-node2.toml:/app/config.toml:ro
    environment:
      - RUST_LOG=info
      - NODE_NAME=node-2
    networks:
      - uploader-network
    restart: unless-stopped
    depends_on:
      - node1
    healthcheck:
      test: ["CMD", "uploader", "ping", "--server", "127.0.0.1:50051"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  node3:
    build: .
    container_name: uploader-node3
    hostname: node3
    ports:
      - "50053:50051"
      - "9002:9000"
    volumes:
      - ./storage-node3:/app/storage
      - ./certs-node3:/app/certs
      - ./config-node3.toml:/app/config.toml:ro
    environment:
      - RUST_LOG=info
      - NODE_NAME=node-3
    networks:
      - uploader-network
    restart: unless-stopped
    depends_on:
      - node1
      - node2
    healthcheck:
      test: ["CMD", "uploader", "ping", "--server", "127.0.0.1:50051"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  uploader-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

volumes:
  storage-node1:
  storage-node2:
  storage-node3:
  certs-node1:
  certs-node2:
  certs-node3:
